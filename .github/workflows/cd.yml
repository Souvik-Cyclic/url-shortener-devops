name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: [self-hosted, k3s, cd]

    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
        # -------------------------------------------------------
        # 1. Checkout Code
        # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

        # -------------------------------------------------------
        # 2. Apply Kubernetes Manifests
        # -------------------------------------------------------
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

        # -------------------------------------------------------
        # 3. Restart Deployment
        # -------------------------------------------------------
      - name: Restart deployment
        run: |
          kubectl rollout restart deployment/url-shortener

        # -------------------------------------------------------
        # 4. Verify Rollout Status
        # -------------------------------------------------------
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/url-shortener

        # -------------------------------------------------------
        # 5. Dummy DAST - Runtime Security Validation
        # -------------------------------------------------------
      - name: Dummy DAST - Basic Runtime Security Checks
        run: |
          echo "Waiting for service to be ready..."
          sleep 10

          TARGET="http://localhost:30001"

          echo "1. Checking service availability..."
          curl -f $TARGET/health

          echo "2. Fetching response headers..."
          curl -I $TARGET | tee headers.txt

          echo "3. Checking basic security headers..."

          grep -qi "x-content-type-options" headers.txt || echo "⚠ Missing X-Content-Type-Options"
          grep -qi "x-frame-options" headers.txt || echo "⚠ Missing X-Frame-Options"
          grep -qi "content-security-policy" headers.txt || echo "⚠ Missing Content-Security-Policy"

          echo "4. Basic response validation..."
          curl -s -o /dev/null -w "%{http_code}" $TARGET | grep -E "200|301|302"

          echo "Dummy DAST completed successfully."
